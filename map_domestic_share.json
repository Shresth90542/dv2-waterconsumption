{
  "$schema": "https://vega.github.io/schema/vega-lite/v6.json",
  "title": "Domestic Share (%) by State",
  "width": 1000,
  "height": 520,
  "projection": {"type": "mercator"},
  "params": [
    {"name": "year", "value": 2019, "bind": {"input": "range", "min": 2003, "max": 2022, "step": 1}}
  ],
  "data": {
    "url": "https://raw.githubusercontent.com/Shresth90542/dv2-waterconsumption/main/water_consumption.csv",
    "format": {"type": "csv"}
  },
  "transform": [
    {"calculate": "year(toDate(datum.date))", "as": "Year"},
    {
      "calculate": "datum.state==='Melaka' ? 'Malacca' : datum.state==='Pulau Pinang' ? 'Penang' : datum.state==='W.P. Labuan' ? 'Labuan' : datum.state",
      "as": "JoinName"
    },
    {"filter": "datum.Year == year && datum.JoinName != 'Malaysia'"},
    {"calculate": "lower(datum.sector)", "as": "sector_lc"},
    {
      "pivot": "sector_lc",
      "value": "value",
      "groupby": ["JoinName"],
      "op": "sum"
    },
    {"calculate": "(datum.domestic + datum.nondomestic)", "as": "TotalCons"},
    {"calculate": "datum.TotalCons == 0 ? null : datum.domestic / datum.TotalCons * 100", "as": "DomesticPct"},
    {
      "lookup": "JoinName",
      "from": {
        "data": {
          "url": "https://gist.github.com/heiswayi/81a169ab39dcf749c31a.js",
          "format": {"type": "json"}
        },
        "key": "properties.name",
        "fields": ["type", "properties", "geometry"]
      }
    }
  ],
  "mark": {"type": "geoshape", "stroke": "#ffffff", "strokeWidth": 0.6},
  "encoding": {
    "shape": {"field": "geometry", "type": "geojson"},
    "color": {
      "field": "DomesticPct",
      "type": "quantitative",
      "title": "Domestic share (%)",
      "scale": {"scheme": "tealblues"},
      "legend": {"format": ".0f"}
    },
    "tooltip": [
      {"field": "JoinName", "title": "State"},
      {"field": "DomesticPct", "type": "quantitative", "title": "Domestic share (%)", "format": ".1f"},
      {"field": "domestic", "type": "quantitative", "title": "Domestic (MLD)"},
      {"field": "nondomestic", "type": "quantitative", "title": "Non-domestic (MLD)"}
    ]
  }
}
